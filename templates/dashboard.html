<!DOCTYPE html>
<html>
<head>
    <title>Junction Box Alert System</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- Leaflet -->
    <link rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { overflow: hidden; margin: 0; }
        #sidebar {
            height: 100vh;
            background: #1f2937;
            color: white;
            overflow-y: auto;
        }
        #map {
            height: 100vh;
        }
        .device-item {
            cursor: pointer;
            padding: 12px 15px;
            border-bottom: 1px solid #374151;
            transition: background 0.2s;
        }
        .device-item:hover {
            background: #374151;
        }
        .device-id {
            font-size: 0.85em;
            color: #9ca3af;
        }
        .alert-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
        }
        .alert-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 0;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-timestamp {
            font-size: 0.8em;
            color: #6b7280;
        }
        .alert-message {
            margin: 5px 0;
            color: #111827;
        }
        .image-icon {
            cursor: pointer;
            color: #3b82f6;
            text-decoration: underline;
            font-size: 0.9em;
        }
        .image-icon:hover {
            color: #1d4ed8;
        }
        .demo-controls {
            padding: 15px;
            background: #111827;
            border-top: 1px solid #374151;
        }
        .btn-demo {
            width: 100%;
            margin-top: 10px;
        }
        .modal-image {
            max-width: 100%;
            height: auto;
        }
        .power-status {
            font-size: 0.75em;
            margin-top: 5px;
        }
        .power-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        .power-on {
            background-color: #10b981;
        }
        .power-off {
            background-color: #ef4444;
        }
        .power-box {
            background: #f9fafb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            color: #111827;
        }
        .power-box.success {
            border-left: 4px solid #10b981;
        }
        .power-box.warning {
            border-left: 4px solid #f59e0b;
        }
        .power-box.danger {
            border-left: 4px solid #ef4444;
        }
        .power-box.info {
            border-left: 4px solid #3b82f6;
        }
        .security-breach-box {
            background: #f9fafb;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            color: #111827;
            border-left: 4px solid;
        }
        .security-breach-box.detected {
            border-left-color: #ef4444;
        }
        .security-breach-box.not-detected {
            border-left-color: #10b981;
        }
        .security-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        .security-breach-red {
            background-color: #ef4444;
        }
        .security-breach-green {
            background-color: #10b981;
        }
        .history-section {
            margin-top: 20px;
            padding: 15px;
            background: #111827;
            border-top: 1px solid #374151;
        }
        .history-section h6 {
            color: white;
            margin-bottom: 10px;
        }
        .history-item {
            background: #1f2937;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 3px solid #3b82f6;
            transition: all 0.2s;
            color: #e5e7eb;
            font-size: 0.85em;
        }
        .history-item:hover {
            background: #374151;
            border-left-color: #60a5fa;
        }
        .history-item-time {
            font-size: 0.75em;
            color: #9ca3af;
            display: block;
            margin-bottom: 3px;
        }
        .history-item-type {
            display: block;
            font-weight: 500;
            color: #60a5fa;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-3 p-0" id="sidebar">
            <div class="p-3">
                <h4>ðŸ”Œ Junction Boxes</h4>
                <p class="text-muted small">Click device to view alerts</p>
            </div>
            <div id="device-list"></div>
            
            <!-- Power Status Info -->
            <div class="demo-controls">
                <h6>Power Monitoring</h6>
                <p class="text-muted small mb-0">Real-time power status updates every 2 seconds</p>
            </div>

            <!-- Alert History Section -->
            <div class="history-section">
                <h6>ðŸ“‹ Alert History</h6>
                <div id="alert-history" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted small">No alerts yet</p>
                </div>
            </div>
        </div>

        <!-- Map Area -->
        <div class="col-9 p-0">
            <div id="map"></div>
        </div>

    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alert Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="modal-image" src="" alt="Alert Image">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var map = L.map('map').setView([18.645917, 73.792500], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var markers = {};
    var devices = [];
    var allAlerts = [];
    var lastAlertCount = 0;

    // Load all alerts at startup
    function loadAlertsHistory() {
        fetch('/alerts-history')
        .then(res => res.json())
        .then(data => {
            allAlerts = data;
            
            // Check if new alert arrived
            if (data.length > lastAlertCount) {
                // Get the newest alert
                let newAlert = data[data.length - 1];
                lastAlertCount = data.length;
                
                // Automatically show popup for the device with new alert
                if (markers[newAlert.device_id]) {
                    map.setView(markers[newAlert.device_id].getLatLng(), 15);
                    setTimeout(() => {
                        showDeviceAlerts(newAlert.device_id);
                    }, 500);
                }
            }
            
            updateAlertHistoryDisplay();
        });
    }

    function updateAlertHistoryDisplay() {
        let historyDiv = document.getElementById("alert-history");
        if (allAlerts.length === 0) {
            historyDiv.innerHTML = '<p class="text-muted small">No alerts yet</p>';
        } else {
            historyDiv.innerHTML = allAlerts.reverse().slice(0, 10).map(alert => `
                <div class="history-item" onclick="viewHistoricalAlert(${alert.id})">
                    <span class="history-item-time">${alert.timestamp}</span>
                    <span class="history-item-type">${alert.alert_type}</span>
                    <small style="color: #9ca3af;">${alert.device_id}</small>
                </div>
            `).join('');
        }
    }

    function viewHistoricalAlert(alertId) {
        let alert = allAlerts.find(a => a.id === alertId);
        if (!alert) return;

        // Show alert details in a modal or popup
        let detailsHtml = `
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <strong>Device ID:</strong> ${alert.device_id}<br>
                    <strong>Alert Type:</strong> ${alert.alert_type}<br>
                    <strong>Timestamp:</strong> ${alert.timestamp}<br>
                    <strong>Message:</strong> ${alert.message}
                </div>
        `;

        if (alert.image && alert.image !== 'placeholder.jpg') {
            detailsHtml += `
                <div style="margin-top: 15px; text-align: center;">
                    <img src="/images/${alert.image}" style="max-width: 100%; max-height: 300px; border-radius: 4px;">
                </div>
            `;
        }

        detailsHtml += '</div>';

        // Create a modal for alert details
        let modal = document.createElement('div');
        modal.id = 'alertDetailsModal';
        modal.className = 'modal fade';
        modal.tabIndex = -1;
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Alert Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${detailsHtml}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        let bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Clean up modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
    }

    // Load all devices at startup
    fetch('/devices')
    .then(res => res.json())
    .then(data => {
        devices = data;
        let deviceList = document.getElementById("device-list");

        data.forEach(device => {
            // Add marker to map
            let marker = L.marker([device.lat, device.lng])
                .addTo(map);

            markers[device.id] = marker;

            // Click handler for marker
            marker.on('click', function() {
                showDeviceAlerts(device.id);
            });

            // Add device to sidebar
            let div = document.createElement("div");
            div.className = "device-item";
            div.id = `device-${device.id}`;
            div.innerHTML = `
                <div><strong>${device.name}</strong></div>
                <div class="device-id">ID: ${device.id}</div>
                <div class="power-status" id="power-${device.id}">
                    <span class="power-indicator power-on"></span>Main: ON
                    <span class="power-indicator power-on" style="margin-left: 8px;"></span>Backup: ON
                </div>
            `;

            div.onclick = function() {
                focusDevice(device.id);
            };

            deviceList.appendChild(div);
            
            // Start updating power status for this device
            updatePowerStatus(device.id);
        });
        
        // Load alert history
        loadAlertsHistory();
        
        // Refresh alert history every 1 second to detect new alerts quickly
        setInterval(loadAlertsHistory, 1000);
        
        // Start continuous power status updates
        setInterval(updateAllPowerStatus, 2000);
    });

    function updatePowerStatus(deviceId) {
        fetch(`/device/${deviceId}/power-status`)
        .then(res => res.json())
        .then(data => {
            let powerDiv = document.getElementById(`power-${deviceId}`);
            if (powerDiv) {
                let mainClass = data.main_supply === "ON" ? "power-on" : "power-off";
                let backupClass = data.backup_supply === "ON" ? "power-on" : "power-off";
                
                powerDiv.innerHTML = `
                    <span class="power-indicator ${mainClass}"></span>Main: ${data.main_supply}
                    <span class="power-indicator ${backupClass}" style="margin-left: 8px;"></span>Backup: ${data.backup_supply}
                `;
            }
        });
    }

    function updateAllPowerStatus() {
        devices.forEach(device => {
            updatePowerStatus(device.id);
            
            // Simulate power changes occasionally (10% chance every 2 seconds)
            if (Math.random() < 0.1) {
                fetch('/simulate-power-change', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_id: device.id
                    })
                });
            }
        });
    }

    function focusDevice(id) {
        let marker = markers[id];
        if(marker) {
            map.setView(marker.getLatLng(), 15);
            showDeviceAlerts(id);
        }
    }

    function showDeviceAlerts(deviceId) {
        // Fetch both alerts and power status
        Promise.all([
            fetch(`/device/${deviceId}/alerts`).then(res => res.json()),
            fetch(`/device/${deviceId}/power-status`).then(res => res.json())
        ])
        .then(([alerts, powerData]) => {
            let marker = markers[deviceId];
            
            // Build power status HTML
            let powerHtml = `
                <div class="power-box ${powerData.state_class}">
                    <strong>Power Status:</strong><br>
                    <small>
                        Main Supply: <strong>${powerData.main_supply}</strong><br>
                        Backup Supply: <strong>${powerData.backup_supply}</strong><br>
                        Status: <strong>${powerData.state}</strong>
                    </small>
                </div>
            `;
            
            // Calculate security breach status
            let securityHtml = '';
            let now = new Date();
            let breachDetected = false;
            
            if (alerts.length > 0) {
                // Get the most recent alert
                let mostRecentAlert = alerts[alerts.length - 1];
                let alertTime = new Date(mostRecentAlert.timestamp);
                let timeDiffMinutes = (now - alertTime) / (1000 * 60);
                
                if (timeDiffMinutes <= 30) {
                    breachDetected = true;
                }
            }
            
            if (breachDetected) {
                securityHtml = `
                    <div class="security-breach-box detected">
                        <span class="security-indicator security-breach-red"></span>
                        <strong>Security Breach : Alert detected</strong>
                    </div>
                `;
            } else {
                securityHtml = `
                    <div class="security-breach-box not-detected">
                        <span class="security-indicator security-breach-green"></span>
                        <strong>Security breach : Alert not detected</strong>
                    </div>
                `;
            }
            
            // Show ONLY the most recent alert
            let alertsHtml = '';
            if (alerts.length === 0) {
                alertsHtml = '<p class="text-muted">No alerts received yet.</p>';
            } else {
                let mostRecentAlert = alerts[alerts.length - 1];
                alertsHtml = `
                    <div class="alert-item">
                        <div class="alert-timestamp">${mostRecentAlert.timestamp}</div>
                        <div class="alert-message"><strong>${mostRecentAlert.alert_type}:</strong> ${mostRecentAlert.message}</div>
                        <div class="image-icon" onclick="showImage('${mostRecentAlert.image}')">
                            ðŸ“· View Image
                        </div>
                    </div>
                `;
            }

            marker.bindPopup(`
                <div class="alert-box">
                    <h6><strong>Device ${deviceId}</strong></h6>
                    ${powerHtml}
                    ${securityHtml}
                    <div style="margin-top: 10px;">
                        <strong>Most Recent Alert:</strong>
                        ${alertsHtml}
                    </div>
                </div>
            `, {maxWidth: 350}).openPopup();
        });
    }

    function showImage(filename) {
        document.getElementById('modalImage').src = `/images/${filename}`;
        let modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }
</script>

</body>

</html>
